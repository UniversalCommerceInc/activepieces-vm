name: Build and Deploy on VM

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Your VM must be a registered GitHub Actions runner

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 📝 Create .env File
        run: |
          cat <<EOF > .env
          AP_POSTGRES_DATABASE=${{ secrets.AP_POSTGRES_DATABASE }}
          AP_POSTGRES_USERNAME=${{ secrets.AP_POSTGRES_USERNAME }}
          AP_POSTGRES_PASSWORD=${{ secrets.AP_POSTGRES_PASSWORD }}
          EOF

      - name: 🧱 Build Docker Images
        run: docker compose build

      - name: 🚀 Deploy Containers
        run: docker compose up -d --force-recreate
